<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>messegeppl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for chat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Game Canvas Styling */
        #gameCanvas {
            background-color: #1e293b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
            max-width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 h-screen flex overflow-hidden font-sans selection:bg-blue-200 dark:selection:bg-blue-900">

    <!-- Sidebar Navigation -->
    <aside class="w-20 md:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-all duration-300 z-20">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-center md:justify-start gap-3">
            <div class="bg-blue-500 text-white p-2 rounded-xl">
                <i data-lucide="message-square-dashed"></i>
            </div>
            <h1 class="font-bold text-xl hidden md:block tracking-tight">messegeppl</h1>
        </div>
        
        <div class="flex-1 overflow-y-auto py-4">
            <h2 class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 hidden md:block">Messages</h2>
            <ul class="space-y-1 px-2" id="chatList">
                <li>
                    <button onclick="switchRoom('jeff')" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400" id="btn-room-jeff">
                        <div class="relative">
                            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-800 flex items-center justify-center text-blue-500 dark:text-blue-300 shrink-0">
                                <i data-lucide="bot" class="w-6 h-6"></i>
                            </div>
                            <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-gray-800 rounded-full"></div>
                        </div>
                        <div class="flex-1 text-left hidden md:block">
                            <h3 class="font-semibold text-sm text-gray-900 dark:text-white">Jeff (AI)</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Test bot</p>
                        </div>
                    </button>
                </li>
            </ul>

            <h2 class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mt-6 mb-2 hidden md:block">Apps</h2>
            <ul class="space-y-1 px-2">
                <li>
                    <button onclick="showGamesView()" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="btn-nav-games">
                        <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 shrink-0">
                            <i data-lucide="gamepad-2" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1 text-left hidden md:block">
                            <h3 class="font-semibold text-sm text-gray-900 dark:text-white">Arcade</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">Play offline</p>
                        </div>
                    </button>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 relative flex flex-col bg-gray-50 dark:bg-gray-900 h-full w-full">
        
        <!-- ==================== CHAT VIEW ==================== -->
        <div id="chatView" class="flex flex-col h-full w-full">
            <header class="h-16 px-4 md:px-6 border-b border-gray-200 dark:border-gray-700 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <h2 class="font-bold text-lg" id="chatTitle">Jeff (AI)</h2>
                </div>
            </header>

            <div id="messagesArea" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4 flex flex-col pb-20 md:pb-6">
                <!-- Messages injected here -->
            </div>

            <div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 absolute md:relative bottom-0 left-0 right-0 z-10">
                <form id="messageForm" class="flex items-end gap-2 max-w-4xl mx-auto">
                    <div class="flex-1 relative">
                        <input type="text" id="messageInput" autocomplete="off" placeholder="Type a message..." 
                            class="w-full bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl pl-4 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all border-none">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 transition-colors transform active:scale-95 shrink-0 flex items-center justify-center h-[48px] w-[48px]">
                        <i data-lucide="send" class="w-5 h-5 ml-1"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- ==================== GAMES VIEW ==================== -->
        <div id="gamesView" class="hidden flex-col h-full w-full bg-gray-100 dark:bg-gray-900 overflow-y-auto">
            <header class="h-16 px-4 md:px-6 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex items-center sticky top-0 z-10">
                <div class="flex items-center gap-3 text-purple-600 dark:text-purple-400">
                    <i data-lucide="gamepad-2"></i>
                    <h2 class="font-bold text-lg text-gray-900 dark:text-white">Offline Arcade</h2>
                </div>
            </header>
            
            <div class="flex-1 p-4 md:p-8 flex flex-col items-center justify-center">
                <div class="max-w-md w-full bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col items-center">
                    
                    <div class="w-full flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold flex items-center gap-2">üêç Retro Snake</h3>
                        <div class="bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-lg font-mono font-bold text-lg">
                            Score: <span id="snakeScore" class="text-blue-500">0</span>
                        </div>
                    </div>

                    <canvas id="gameCanvas" width="300" height="300" class="mb-6"></canvas>

                    <div id="gameOverlay" class="w-full flex flex-col items-center">
                        <button id="btnStartGame" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold text-lg transition-transform active:scale-95 shadow-md">
                            Start Game
                        </button>
                        <p class="text-xs text-gray-500 mt-3 text-center">Data is stored locally in memory. High scores vanish when you leave!</p>
                    </div>

                    <div id="mobileControls" class="w-full mt-4 hidden grid-cols-3 gap-2 max-w-[200px] mx-auto">
                        <div></div>
                        <button class="bg-gray-200 dark:bg-gray-700 p-4 rounded-xl active:bg-gray-300 flex justify-center" id="btnUp"><i data-lucide="arrow-up"></i></button>
                        <div></div>
                        <button class="bg-gray-200 dark:bg-gray-700 p-4 rounded-xl active:bg-gray-300 flex justify-center" id="btnLeft"><i data-lucide="arrow-left"></i></button>
                        <button class="bg-gray-200 dark:bg-gray-700 p-4 rounded-xl active:bg-gray-300 flex justify-center" id="btnDown"><i data-lucide="arrow-down"></i></button>
                        <button class="bg-gray-200 dark:bg-gray-700 p-4 rounded-xl active:bg-gray-300 flex justify-center" id="btnRight"><i data-lucide="arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Logic & Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // ==========================================
        // GITHUB EXPORT SETTINGS
        // ==========================================
        
        // 1. To make AI work on GitHub, put your Google Gemini API Key inside these quotes.
        // In this testing sandbox, it injects automatically.
        const apiKey = ""; 

        // 2. To make Chat work on GitHub, replace 'null' with your Firebase Config object.
        // Example: const myGitHubFirebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." };
        const myGitHubFirebaseConfig = null; 

        // Application Globals
        let db = null;
        let auth = null;
        let currentUser = null;
        let localUsername = "Anonymous_" + Math.floor(Math.random() * 1000);
        let currentRoomId = 'jeff'; 
        let unsubscribeSnapshot = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'messegeppl-external';

        // UI Elements
        const ui = {
            chatView: document.getElementById('chatView'),
            gamesView: document.getElementById('gamesView'),
            chatTitle: document.getElementById('chatTitle'),
            messagesArea: document.getElementById('messagesArea'),
            messageForm: document.getElementById('messageForm'),
            messageInput: document.getElementById('messageInput'),
            btnNavGames: document.getElementById('btn-nav-games'),
            btnRoomJeff: document.getElementById('btn-room-jeff')
        };

        // --- View Switching Logic ---
        window.switchRoom = function(roomId) {
            currentRoomId = roomId;
            ui.chatTitle.textContent = roomId === 'jeff' ? 'Jeff (AI)' : roomId;
            
            // Fix: Stop the snake game so typing WASD in chat doesn't move the snake!
            isGameRunning = false; 

            ui.btnRoomJeff.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
            ui.btnNavGames.classList.remove('bg-purple-50', 'dark:bg-purple-900/20');

            ui.gamesView.classList.add('hidden');
            ui.gamesView.classList.remove('flex');
            ui.chatView.classList.remove('hidden');
            ui.chatView.classList.add('flex');

            loadMessages();
        };

        window.showGamesView = function() {
            ui.btnRoomJeff.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
            ui.btnNavGames.classList.add('bg-purple-50', 'dark:bg-purple-900/20');

            ui.chatView.classList.add('hidden');
            ui.chatView.classList.remove('flex');
            ui.gamesView.classList.remove('hidden');
            ui.gamesView.classList.add('flex');
        };

        // --- Firebase Initialization (GitHub Proofed) ---
        async function initFirebase() {
            try {
                let firebaseConfigToUse = null;
                let useInjectedToken = false;

                // Check if we are in the Sandbox OR if the user provided their own config for GitHub
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfigToUse = JSON.parse(__firebase_config);
                    useInjectedToken = true;
                } else if (myGitHubFirebaseConfig !== null) {
                    firebaseConfigToUse = myGitHubFirebaseConfig;
                } else {
                    console.warn("No Firebase config found. Chat is disabled on GitHub until configured.");
                    ui.messagesArea.innerHTML = '<div class="text-center text-red-500 text-sm my-10 bg-red-100 dark:bg-red-900/20 p-4 rounded-xl mx-4"><b>Database not connected.</b><br>If you are hosting this on GitHub, please add your Firebase config to the code.</div>';
                    return;
                }

                const app = initializeApp(firebaseConfigToUse);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authenticate
                if (useInjectedToken && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user && ui.chatView.classList.contains('flex')) {
                        loadMessages();
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }
        initFirebase();

        // --- Chat Logic ---
        function loadMessages() {
            if (!db || !currentUser) return; // Prevent crashing if DB isn't configured on GitHub
            
            if (unsubscribeSnapshot) unsubscribeSnapshot();

            ui.messagesArea.innerHTML = '<div class="text-center text-gray-400 text-sm my-4">Loading messages...</div>';

            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', `chat_${currentRoomId}`);
            
            unsubscribeSnapshot = onSnapshot(roomRef, (snapshot) => {
                ui.messagesArea.innerHTML = '';
                
                let msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                
                msgs.sort((a, b) => {
                    const tA = a.timestamp?.toMillis() || 0;
                    const tB = b.timestamp?.toMillis() || 0;
                    return tA - tB;
                });

                if (msgs.length === 0) {
                    ui.messagesArea.innerHTML = `<div class="text-center text-gray-400 text-sm my-4">This is the start of your chat with ${currentRoomId}.</div>`;
                }

                msgs.forEach(data => {
                    const isMe = data.uid === currentUser.uid;
                    const timeString = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Sending...';
                    
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-fade-in-up`;
                    
                    msgDiv.innerHTML = `
                        <span class="text-[10px] text-gray-400 mb-1 px-2">${data.senderName} ‚Ä¢ ${timeString}</span>
                        <div class="max-w-[80%] md:max-w-[70%] rounded-2xl px-4 py-2 text-sm md:text-base shadow-sm
                            ${isMe ? 'bg-blue-500 text-white rounded-tr-sm' : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-tl-sm border border-gray-100 dark:border-gray-700'}">
                            ${data.text}
                        </div>
                    `;
                    ui.messagesArea.appendChild(msgDiv);
                });
                ui.messagesArea.scrollTop = ui.messagesArea.scrollHeight;
            }, (error) => {
                console.error("Snapshot error:", error);
                ui.messagesArea.innerHTML = `<div class="text-center text-red-400 text-sm my-4">Error loading messages. Check database permissions.</div>`;
            });
        }

        ui.messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = ui.messageInput.value.trim();
            if (!text || !db || !currentUser) return;

            ui.messageInput.value = '';
            const roomRef = collection(db, 'artifacts', appId, 'public', 'data', `chat_${currentRoomId}`);
            
            try {
                await addDoc(roomRef, {
                    text: text,
                    uid: currentUser.uid,
                    senderName: localUsername,
                    timestamp: serverTimestamp()
                });

                if (currentRoomId === 'jeff') {
                    if (!apiKey) {
                        console.warn("No API key provided. Jeff cannot respond.");
                        return; // Fail gracefully on GitHub if key is missing
                    }

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: "You are Jeff, a friendly chat testing bot on 'messegeppl'." }] }
                    };

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const botText = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm not sure what to say.";
                        await addDoc(roomRef, {
                            text: botText,
                            uid: "jeff-bot-id",
                            senderName: "Jeff",
                            timestamp: serverTimestamp()
                        });
                    }
                }
            } catch (error) {
                console.error("Error sending message:", error);
            }
        });


        // ==========================================
        // SNAKE GAME LOGIC
        // ==========================================
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('snakeScore');
        const btnStartGame = document.getElementById('btnStartGame');
        const mobileControls = document.getElementById('mobileControls');

        const gridSize = 15;
        const tileCount = canvas.width / gridSize;
        
        // Expose globally so view switcher can turn it off
        window.isGameRunning = false; 

        let snake = [];
        let food = { x: 0, y: 0 };
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameLoopTimeout;

        function resetGame() {
            snake = [ { x: 10, y: 10 }, { x: 10, y: 11 }, { x: 10, y: 12 } ];
            dx = 0;
            dy = -1; 
            score = 0;
            scoreElement.innerText = score;
            spawnFood();
            isGameRunning = true;
            btnStartGame.innerText = "Restart Game";
            mobileControls.classList.remove('hidden');
            mobileControls.classList.add('grid');
            
            clearTimeout(gameLoopTimeout);
            gameLoop();
        }

        function spawnFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            for(let part of snake) {
                if(part.x === food.x && part.y === food.y) spawnFood();
            }
        }

        function gameLoop() {
            if(!isGameRunning) return;

            updateSnake();
            
            if (checkGameOver()) {
                isGameRunning = false;
                ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "white";
                ctx.font = "bold 24px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Game Over!", canvas.width / 2, canvas.height / 2);
                ctx.font = "16px sans-serif";
                ctx.fillText(`Final Score: ${score}`, canvas.width / 2, (canvas.height / 2) + 30);
                return;
            }

            drawGame();
            
            let speed = Math.max(50, 150 - (score * 2));
            gameLoopTimeout = setTimeout(gameLoop, speed);
        }

        function updateSnake() {
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.innerText = score;
                spawnFood();
            } else {
                snake.pop(); 
            }
        }

        function drawGame() {
            ctx.fillStyle = "#1e293b"; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = "#334155";
            ctx.lineWidth = 0.5;
            for(let i=0; i<=canvas.width; i+=gridSize) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
            }

            ctx.fillStyle = "#ef4444";
            ctx.beginPath();
            ctx.arc((food.x * gridSize) + gridSize/2, (food.y * gridSize) + gridSize/2, gridSize/2 - 1, 0, Math.PI * 2);
            ctx.fill();

            snake.forEach((part, index) => {
                ctx.fillStyle = index === 0 ? "#10b981" : "#34d399";
                ctx.fillRect(part.x * gridSize + 1, part.y * gridSize + 1, gridSize - 2, gridSize - 2);
            });
        }

        function checkGameOver() {
            const head = snake[0];
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) return true;
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) return true;
            }
            return false;
        }

        // --- Controls ---
        function changeDirection(newDx, newDy) {
            if (dx === 0 && newDx === 0) return; 
            if (dy === 0 && newDy === 0) return;
            dx = newDx;
            dy = newDy;
        }

        window.addEventListener('keydown', (e) => {
            // FIX: If the games view is hidden, completely ignore keyboard presses so we can type in chat normally!
            if (ui.gamesView.classList.contains('hidden')) return;

            if(!isGameRunning && ui.gamesView.classList.contains('flex')) {
                if(e.code === 'Space') { e.preventDefault(); resetGame(); }
                return;
            }
            if(!isGameRunning) return;

            switch(e.key.toLowerCase()) {
                case 'arrowup': case 'w': e.preventDefault(); changeDirection(0, -1); break;
                case 'arrowdown': case 's': e.preventDefault(); changeDirection(0, 1); break;
                case 'arrowleft': case 'a': e.preventDefault(); changeDirection(-1, 0); break;
                case 'arrowright': case 'd': e.preventDefault(); changeDirection(1, 0); break;
            }
        });

        // Mobile Controls
        document.getElementById('btnUp').addEventListener('pointerdown', (e) => { e.preventDefault(); changeDirection(0, -1); });
        document.getElementById('btnDown').addEventListener('pointerdown', (e) => { e.preventDefault(); changeDirection(0, 1); });
        document.getElementById('btnLeft').addEventListener('pointerdown', (e) => { e.preventDefault(); changeDirection(-1, 0); });
        document.getElementById('btnRight').addEventListener('pointerdown', (e) => { e.preventDefault(); changeDirection(1, 0); });

        btnStartGame.addEventListener('click', resetGame);

        // Initial draw
        ctx.fillStyle = "#1e293b";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "white";
        ctx.font = "16px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("Ready to play?", canvas.width / 2, canvas.height / 2);

    </script>
</body>
</html>
